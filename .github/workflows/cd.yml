name: CD

on:
  push:
    branches: [ "main" ]
    paths:
      - 'src/**'
      - 'k8s/**'
      - '.github/workflows/cd.yml'
  workflow_dispatch:

env:
  ECR_REPOSITORY: payments-service
  IMAGE_TAG: latest

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # 1. Login na AWS
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token: ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region: us-east-1

      # 2. Login no ECR
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      # 3. Build e Push
      - name: Build and Push Docker Image
        id: build-push
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        run: |
          set -e
          
          if [ -z "$ECR_REGISTRY" ]; then
            echo "ERRO: ECR_REGISTRY não está definido"
            exit 1
          fi
          
          FULL_IMAGE="$ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG"
          echo "Building image: $FULL_IMAGE"
          
          docker build -t $FULL_IMAGE .
          
          echo "Pushing image to ECR..."
          docker push $FULL_IMAGE
          
          echo "Verificando se imagem foi criada..."
          aws ecr describe-images --repository-name $ECR_REPOSITORY --image-ids imageTag=$IMAGE_TAG --region us-east-1 || {
            echo "ERRO: Imagem não encontrada no ECR após push"
            exit 1
          }
          
          echo "FULL_IMAGE=$FULL_IMAGE" >> $GITHUB_OUTPUT
          echo "Image $FULL_IMAGE pushed successfully"

      # 4. Substituir variáveis nos arquivos K8s
      - name: Prepare K8s manifests
        env:
          FULL_IMAGE: ${{ steps.build-push.outputs.FULL_IMAGE }}
          DB_VAL: ${{ secrets.PAYMENTS_DB_STRING }}
          KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          KEY_SECRET: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          KEY_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          ACC_ID: ${{ secrets.AWS_ACCOUNT_ID }}
        run: |
          set -e
          
          echo "Validando variáveis obrigatórias..."
          if [ -z "$FULL_IMAGE" ]; then
            echo "ERRO: FULL_IMAGE não está definido"
            exit 1
          fi
          if [ -z "$DB_VAL" ]; then
            echo "ERRO: DB_VAL não está definido"
            exit 1
          fi
          if [ -z "$KEY_ID" ] || [ -z "$KEY_SECRET" ] || [ -z "$KEY_TOKEN" ]; then
            echo "ERRO: Credenciais AWS não estão definidas"
            exit 1
          fi
          if [ -z "$ACC_ID" ]; then
            echo "ERRO: ACC_ID não está definido"
            exit 1
          fi
          
          mkdir -p k8s/payments/processed
          export FULL_IMAGE DB_VAL KEY_ID KEY_SECRET KEY_TOKEN ACC_ID
          
          echo "Processando arquivos YAML..."
          if command -v envsubst >/dev/null 2>&1; then
            envsubst < k8s/configmap.yaml > k8s/payments/processed/configmap.yaml
            envsubst < k8s/secret.yaml > k8s/payments/processed/secret.yaml
            envsubst < k8s/deployment.yaml > k8s/payments/processed/deployment.yaml
          else
            sed -e "s|\${FULL_IMAGE}|${FULL_IMAGE}|g" \
                -e "s|\${DB_VAL}|${DB_VAL}|g" \
                -e "s|\${KEY_ID}|${KEY_ID}|g" \
                -e "s|\${KEY_SECRET}|${KEY_SECRET}|g" \
                -e "s|\${KEY_TOKEN}|${KEY_TOKEN}|g" \
                -e "s|\${ACC_ID}|${ACC_ID}|g" \
                k8s/configmap.yaml > k8s/payments/processed/configmap.yaml
            sed -e "s|\${DB_VAL}|${DB_VAL}|g" \
                -e "s|\${KEY_ID}|${KEY_ID}|g" \
                -e "s|\${KEY_SECRET}|${KEY_SECRET}|g" \
                -e "s|\${KEY_TOKEN}|${KEY_TOKEN}|g" \
                k8s/secret.yaml > k8s/payments/processed/secret.yaml
            sed -e "s|\${FULL_IMAGE}|${FULL_IMAGE}|g" \
                k8s/deployment.yaml > k8s/payments/processed/deployment.yaml
          fi
          
          cp k8s/service.yaml k8s/payments/processed/service.yaml
          cp k8s/hpa.yaml k8s/payments/processed/hpa.yaml
          if [ -f k8s/namespace.yaml ]; then
            cp k8s/namespace.yaml k8s/payments/processed/namespace.yaml
          else
            echo "Aviso: namespace.yaml não encontrado, será criado automaticamente"
          fi
          
          echo "Validando YAML gerado..."
          for file in k8s/payments/processed/*.yaml; do
            if [ -f "$file" ]; then
              echo "Validando $file..."
              if ! grep -q "apiVersion" "$file"; then
                echo "ERRO: $file não parece ser um YAML válido"
                exit 1
              fi
              if grep -q '\${' "$file"; then
                echo "ERRO: Variáveis não substituídas em $file:"
                grep '\${' "$file"
                exit 1
              fi
            fi
          done
          
          echo "Arquivos gerados:"
          ls -la k8s/payments/processed/
          
          REQUIRED_FILES=("configmap.yaml" "secret.yaml" "deployment.yaml" "service.yaml" "hpa.yaml")
          for file in "${REQUIRED_FILES[@]}"; do
            if [ ! -f "k8s/payments/processed/$file" ]; then
              echo "ERRO: Arquivo obrigatório não encontrado: $file"
              exit 1
            fi
          done
          
          echo "Todos os arquivos YAML foram gerados e validados com sucesso"

      # 5. Criar diretório e copiar arquivos K8s processados para a EC2
      - name: Prepare directory on EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 60s
          script: |
            set -e
            mkdir -p /home/ubuntu/deploy/k8s/payments
            rm -f /home/ubuntu/deploy/k8s/payments/*.yaml || true
            echo "Diretório preparado: /home/ubuntu/deploy/k8s/payments"

      - name: List files before copy
        run: |
          echo "Arquivos a serem copiados:"
          ls -la k8s/payments/processed/ || echo "Diretório não existe"
          if [ -d "k8s/payments/processed" ]; then
            find k8s/payments/processed -name "*.yaml" -type f
          fi

      - name: Copy K8s files to EC2
        uses: appleboy/scp-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 120s
          source: "k8s/payments/processed/"
          target: "/home/ubuntu/deploy/temp"
          rm: false
          
      - name: Move files to correct location
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 60s
          script: |
            set -e
            echo "Movendo arquivos para localização correta..."
            if [ -d "/home/ubuntu/deploy/temp/payments/processed" ]; then
              mv /home/ubuntu/deploy/temp/payments/processed/*.yaml /home/ubuntu/deploy/k8s/payments/ 2>/dev/null || true
              rm -rf /home/ubuntu/deploy/temp
            elif [ -d "/home/ubuntu/deploy/temp/processed" ]; then
              mv /home/ubuntu/deploy/temp/processed/*.yaml /home/ubuntu/deploy/k8s/payments/ 2>/dev/null || true
              rm -rf /home/ubuntu/deploy/temp
            else
              echo "Procurando arquivos YAML em /home/ubuntu/deploy/temp..."
              find /home/ubuntu/deploy/temp -name "*.yaml" -exec mv {} /home/ubuntu/deploy/k8s/payments/ \; 2>/dev/null || true
              rm -rf /home/ubuntu/deploy/temp
            fi
            echo "Arquivos movidos. Conteúdo final:"
            ls -la /home/ubuntu/deploy/k8s/payments/
          
      - name: Verify files copied to EC2
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 60s
          script: |
            set -e
            echo "Verificando estrutura copiada..."
            echo "Conteúdo de /home/ubuntu/deploy/k8s:"
            ls -la /home/ubuntu/deploy/k8s/ || echo "Diretório k8s não existe"
            echo ""
            echo "Buscando todos os arquivos YAML:"
            find /home/ubuntu/deploy -type f -name "*.yaml" 2>/dev/null || echo "Nenhum arquivo YAML encontrado"
            echo ""
            
            echo "Verificando diretório payments..."
            if [ ! -d "/home/ubuntu/deploy/k8s/payments" ]; then
              echo "ERRO: Diretório /home/ubuntu/deploy/k8s/payments não existe"
              echo "Criando diretório..."
              mkdir -p /home/ubuntu/deploy/k8s/payments
            fi
            
            echo "Conteúdo de /home/ubuntu/deploy/k8s/payments:"
            ls -la /home/ubuntu/deploy/k8s/payments/ || echo "Diretório vazio ou não existe"
            echo ""
            
            REQUIRED_FILES=("configmap.yaml" "secret.yaml" "deployment.yaml" "service.yaml" "hpa.yaml")
            MISSING_FILES=()
            
            for file in "${REQUIRED_FILES[@]}"; do
              if [ ! -f "/home/ubuntu/deploy/k8s/payments/$file" ]; then
                MISSING_FILES+=("$file")
              fi
            done
            
            if [ ${#MISSING_FILES[@]} -ne 0 ]; then
              echo "ERRO: Arquivos não encontrados: ${MISSING_FILES[*]}"
              echo ""
              echo "Tentando encontrar arquivos em outras localizações..."
              find /home/ubuntu/deploy -name "configmap.yaml" -o -name "secret.yaml" -o -name "deployment.yaml" -o -name "service.yaml" -o -name "hpa.yaml" 2>/dev/null || true
              echo ""
              echo "Estrutura completa:"
              find /home/ubuntu/deploy -type f 2>/dev/null || true
              exit 1
            fi
            
            echo "Todos os arquivos foram copiados com sucesso:"
            ls -la /home/ubuntu/deploy/k8s/payments/

      # 6. Deploy na EC2 via SSH
      - name: Deploy via SSH
        uses: appleboy/ssh-action@master
        env:
          ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_SESSION_TOKEN: ${{ secrets.AWS_SESSION_TOKEN }}
          AWS_DEFAULT_REGION: us-east-1
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          timeout: 600s
          script: |
            set -e
            
            echo "=== Configurando kubectl ==="
            if ! command -v kubectl &> /dev/null; then
              echo "ERRO: kubectl não está instalado"
              exit 1
            fi
            
            mkdir -p ~/.kube
            if [ ! -f /etc/rancher/k3s/k3s.yaml ]; then
              echo "ERRO: Arquivo k3s.yaml não encontrado em /etc/rancher/k3s/"
              exit 1
            fi
            
            sudo cp /etc/rancher/k3s/k3s.yaml ~/.kube/config
            sudo chown ubuntu:ubuntu ~/.kube/config
            chmod 600 ~/.kube/config
            export KUBECONFIG=~/.kube/config
            
            echo "Verificando conectividade com cluster..."
            if ! kubectl cluster-info &> /dev/null; then
              echo "ERRO: Não foi possível conectar ao cluster"
              exit 1
            fi
            kubectl get nodes || {
              echo "ERRO: Não foi possível listar nodes"
              exit 1
            }
            
            echo "=== Criando/Criando Namespace ==="
            kubectl create namespace payments --dry-run=client -o yaml | kubectl apply -f - || {
              echo "Namespace já existe ou erro ao criar"
            }
            echo "Aguardando namespace ficar ativo..."
            kubectl wait --for=condition=Active namespace/payments --timeout=60s || {
              echo "Aviso: Timeout aguardando namespace, mas continuando..."
            }
            
            echo "=== Criando ImagePullSecret para ECR ==="
            
            if [ -z "$ECR_REGISTRY" ]; then
              echo "ERRO: ECR_REGISTRY não está definido"
              exit 1
            fi
            
            echo "ECR_REGISTRY: $ECR_REGISTRY"
            ECR_REPOSITORY="payments-service"
            AWS_REGION="us-east-1"
            
            if kubectl get secret ecr-secret -n payments &> /dev/null; then
              echo "ImagePullSecret já existe, atualizando..."
              kubectl delete secret ecr-secret -n payments || true
            fi
            
            if ! command -v aws &> /dev/null; then
              echo "ERRO: AWS CLI não está instalado na EC2"
              echo "Instalando AWS CLI..."
              curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip" || {
                echo "ERRO: Falha ao baixar AWS CLI"
                exit 1
              }
              unzip awscliv2.zip || {
                echo "ERRO: Falha ao descompactar AWS CLI"
                exit 1
              }
              sudo ./aws/install || {
                echo "ERRO: Falha ao instalar AWS CLI"
                exit 1
              }
              rm -rf awscliv2.zip aws
            fi
            
            echo "Configurando credenciais AWS..."
            export AWS_DEFAULT_REGION=$AWS_REGION
            export AWS_REGION=$AWS_REGION
            
            if [ -z "$AWS_ACCESS_KEY_ID" ] || [ -z "$AWS_SECRET_ACCESS_KEY" ]; then
              echo "ERRO: Credenciais AWS não estão definidas"
              exit 1
            fi
            
            echo "Obtendo token do ECR..."
            TOKEN=$(aws ecr get-login-password --region $AWS_REGION 2>&1) || {
              echo "ERRO: Falha ao obter token do ECR"
              echo "Verifique as credenciais AWS e permissões"
              exit 1
            }
            
            if [ -z "$TOKEN" ]; then
              echo "ERRO: Token do ECR está vazio"
              exit 1
            fi
            
            echo "Criando ImagePullSecret..."
            kubectl create secret docker-registry ecr-secret \
              --docker-server="$ECR_REGISTRY" \
              --docker-username=AWS \
              --docker-password="$TOKEN" \
              --namespace=payments || {
              echo "ERRO: Falha ao criar ImagePullSecret"
              echo "ECR_REGISTRY: $ECR_REGISTRY"
              echo "Token length: ${#TOKEN}"
              exit 1
            }
            echo "ImagePullSecret criado com sucesso"
            
            echo "=== Validando arquivos YAML ==="
            for file in /home/ubuntu/deploy/k8s/payments/*.yaml; do
              if [ -f "$file" ]; then
                echo "Validando $file..."
                kubectl apply --dry-run=client -f "$file" || {
                  echo "ERRO: YAML inválido: $file"
                  exit 1
                }
              fi
            done
            
            echo "=== Aplicando recursos ==="
            
            if [ -f /home/ubuntu/deploy/k8s/payments/namespace.yaml ]; then
              echo "Aplicando Namespace..."
              kubectl apply -f /home/ubuntu/deploy/k8s/payments/namespace.yaml
            fi
            
            echo "Aplicando ConfigMap..."
            kubectl apply -f /home/ubuntu/deploy/k8s/payments/configmap.yaml || {
              echo "ERRO: Falha ao aplicar ConfigMap"
              exit 1
            }
            
            echo "Aplicando Secret..."
            kubectl apply -f /home/ubuntu/deploy/k8s/payments/secret.yaml || {
              echo "ERRO: Falha ao aplicar Secret"
              exit 1
            }
            
            echo "Aguardando ConfigMap e Secret ficarem prontos..."
            sleep 2
            
            echo "Aplicando Deployment..."
            kubectl apply -f /home/ubuntu/deploy/k8s/payments/deployment.yaml || {
              echo "ERRO: Falha ao aplicar Deployment"
              exit 1
            }
            
            echo "Aplicando Service..."
            kubectl apply -f /home/ubuntu/deploy/k8s/payments/service.yaml || {
              echo "ERRO: Falha ao aplicar Service"
              exit 1
            }
            
            echo "Aplicando HPA..."
            kubectl apply -f /home/ubuntu/deploy/k8s/payments/hpa.yaml || {
              echo "ERRO: Falha ao aplicar HPA"
              exit 1
            }
            
            echo "=== Aguardando Deployment ficar pronto ==="
            echo "Aguardando pods iniciarem..."
            sleep 5
            
            echo "Forçando atualização do deployment..."
            kubectl rollout restart deployment/payments-deployment -n payments || {
              echo "Aviso: Falha ao reiniciar deployment (pode ser primeira vez)"
            }
            
            echo "Aguardando rollout completar..."
            if ! kubectl rollout status deployment/payments-deployment -n payments --timeout=300s; then
              echo "ERRO: Rollout falhou ou timeout"
              echo "Status dos pods:"
              kubectl get pods -n payments
              echo "Logs do deployment:"
              kubectl describe deployment payments-deployment -n payments
              exit 1
            fi
            
            echo "=== Verificando saúde do deployment ==="
            READY=$(kubectl get deployment payments-deployment -n payments -o jsonpath='{.status.readyReplicas}' || echo "0")
            DESIRED=$(kubectl get deployment payments-deployment -n payments -o jsonpath='{.spec.replicas}' || echo "0")
            
            if [ "$READY" != "$DESIRED" ]; then
              echo "ERRO: Deployment não está pronto. Ready: $READY, Desired: $DESIRED"
              kubectl get pods -n payments
              kubectl describe deployment payments-deployment -n payments
              exit 1
            fi
            
            echo "=== Status final ==="
            echo "Pods:"
            kubectl get pods -n payments
            echo ""
            echo "Service:"
            kubectl get service payments-service -n payments
            echo ""
            echo "HPA:"
            kubectl get hpa payments-hpa -n payments || echo "HPA ainda não está disponível"
            echo ""
            echo "Deploy concluído com sucesso!"